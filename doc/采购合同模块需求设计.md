# 采购合同模块需求设计

## 1. 概述

### 1.1 模块名称
采购合同管理模块 (PO Contract Management)

### 1.2 模块位置
- 前端路径: `src/views/40_business/pocontract/`
- API路径: `src/api/40_business/pocontract/pocontract.js`
- 权限标识: `P_PO_CONTRACT`

### 1.3 模块功能简述
采购合同管理模块是供应链管理系统中的核心业务模块，负责管理企业与供应商之间的采购合同全生命周期流程，包括合同创建、审批、执行、完成和作废等环节。

## 2. 业务流程分析

### 2.1 主要业务流程
```
合同创建 → 待审批 → 审批中 → 执行中 → 已完成
    ↓
  作废申请 → 作废审批中 → 已作废
```

### 2.2 状态定义
- **待审批**: 合同已创建，等待审批
- **审批中**: 合同正在审批流程中
- **执行中**: 合同已审批通过，正在执行
- **已完成**: 合同执行完毕
- **驳回**: 合同审批被驳回
- **作废审批中**: 合同作废申请在审批中
- **已作废**: 合同已作废

## 3. 模块架构设计

### 3.1 目录结构
```
pocontract/
├── index.vue                    # 主页面，包含标签页管理
├── dialog/                      # 对话框组件
│   ├── cancel/                  # 作废对话框
│   │   └── index.vue
│   ├── new/                     # 新增对话框
│   │   ├── index.vue
│   │   ├── edit.vue
│   │   └── mixin.js
│   └── push/                    # 下推对话框
│       └── new/
│           ├── index.vue
│           ├── edit.vue
│           └── mixin.js
└── tabs/                        # 标签页组件
    ├── 10_list/                 # 列表页
    │   └── index.vue
    ├── 20_new/                  # 新增页
    │   └── index.vue
    ├── 30_edit/                 # 编辑页
    │   └── index.vue
    ├── 40_view/                 # 查看页
    │   ├── index.vue
    │   └── detail.vue
    ├── 50_approve/              # 审批页
    │   ├── index.vue
    │   └── detail.vue
    └── 60_print/                # 打印页
        └── index.vue
```

### 3.2 主页面设计 (index.vue)
主页面采用标签页(El-tabs)结构，通过状态管理控制不同标签页的显示/隐藏：

- **采购合同-列表**: 默认显示的主页面
- **新增页面**: 动态显示，支持关闭
- **修改页面**: 动态显示，支持关闭
- **查看页面**: 动态显示，支持关闭
- **审批页面**: 动态显示，支持关闭

## 4. 功能需求详细设计

### 4.1 列表页功能 (10_list)

#### 4.1.1 状态标签页
- **全部**: 显示所有状态的合同
- **待审批**: 显示待审批状态的合同
- **审批中**: 显示审批中状态的合同
- **执行中**: 显示执行中状态的合同
- **已完成**: 显示已完成状态的合同
- **驳回**: 显示被驳回的合同
- **作废审批中**: 显示作废审批中的合同
- **已作废**: 显示已作废的合同

#### 4.1.2 查询条件
**基本查询**:
- 合同编号 (contract_code)
- 供应商 (supplier_name) - 支持选择器
- 主体企业 (purchaser_name) - 支持选择器
- 单据状态 (status_list) - 字典选择
- 合同类型 (type_list) - 字典选择
- 结算方式 (settle_list) - 字典选择
- 结算单据类型 (bill_type_list) - 字典选择

**高级查询**:
- 物料编码或名称 (goods_name)

#### 4.1.3 操作按钮
**主要操作**:
- **新增** (`P_PO_CONTRACT:ADD`): 创建新的采购合同
- **修改** (`P_PO_CONTRACT:UPDATE`): 修改选中的合同
- **删除** (`P_PO_CONTRACT:DELETE`): 删除选中的合同
- **作废** (`P_PO_CONTRACT:CANCEL`): 申请作废合同
- **审批** (`P_PO_CONTRACT:AUDIT`): 审批合同
- **下推订单** (`P_PO_CONTRACT:PUSH`): 将合同下推生成采购订单
- **完成** (`P_PO_CONTRACT:FINISH`): 完成合同执行
- **查看** (`P_PO_CONTRACT:INFO`): 查看合同详情
- **打印** (`P_PO_CONTRACT:PRINT`): 打印合同单据

**数据操作**:
- **导入** (`P_PO_CONTRACT:IMPORT`): 批量导入合同数据
- **导出** (`P_PO_CONTRACT:EXPORT`): 导出合同数据

#### 4.1.4 统计信息
页面底部显示以下统计数据：
- **合同总金额**: 所有合同的总金额
- **合同总采购数量**: 所有合同的总采购数量
- **预付未付总金额**: 预付款中未支付的总金额
- **预付已付款总金额**: 已支付的预付款总金额

### 4.2 新增功能 (20_new)

#### 4.2.1 基本信息
- **系统编号**: 系统自动生成
- **合同编号**: 手动输入，必填
- **类型**: 合同类型，单选，必填
- **供应商**: 从供应商选择器中选择，必填
- **主体企业**: 从客户选择器中选择，必填
- **合同日期**: 合同签订日期
- **生效日期**: 合同生效日期
- **失效日期**: 合同失效日期

#### 4.2.2 详细信息
- **结算方式**: 从字典中选择
- **结算单据类型**: 从字典中选择
- **币种**: 货币类型选择
- **汇率**: 对应币种的汇率
- **备注**: 合同备注信息

#### 4.2.3 物料明细
支持添加多个物料明细，包含：
- 物料信息
- 采购数量
- 单价
- 总金额
- 交货日期等

#### 4.2.4 验证规则
- 合同编号不能为空
- 供应商必须选择
- 主体企业必须选择
- 合同类型必须选择
- 物料明细不能为空

### 4.3 修改功能 (30_edit)

#### 4.3.1 修改条件
- 只有待审批状态的合同可以修改
- 需要具备修改权限
- 修改时需要填写修改原因

#### 4.3.2 修改限制
- 已审批的合同不能修改基本信息
- 执行中的合同只能修改部分字段
- 已完成或已作废的合同不能修改

### 4.4 查看功能 (40_view)

#### 4.4.1 详情展示
- 完整显示合同的所有信息
- 只读模式，不可编辑
- 支持打印功能

#### 4.4.2 相关单据
- 显示关联的采购订单
- 显示相关的收货单据
- 显示相关的付款单据

### 4.5 审批功能 (50_approve)

#### 4.5.1 审批页面布局
- **左侧**: 合同详细信息展示 (占比75%)
- **右侧**: 审批流程信息展示 (占比25%)
- **底部**: 审批操作按钮区域

#### 4.5.2 审批操作
- **同意**: 审批通过，进入下一审批节点或完成审批
- **驳回**: 审批驳回，返回到申请人
- **转办**: 转给其他人审批
- **加签**: 增加审批人
- **撤销**: 撤销审批申请 (特定条件下)

#### 4.5.3 审批流程
- 显示当前审批节点
- 显示审批历史记录
- 显示下一步审批人信息

### 4.6 作废功能

#### 4.6.1 作废条件
- 合同必须是执行中状态
- 需要具备作废权限
- 必须填写作废理由

#### 4.6.2 作废流程
1. 点击作废按钮
2. 弹出作废对话框
3. 填写作废理由 (必填)
4. 提交作废申请
5. 进入作废审批流程

### 4.7 下推功能

#### 4.7.1 下推条件
- 合同必须是执行中状态
- 需要具备下推权限
- 合同中必须有可下推的物料

#### 4.7.2 下推流程
1. 选择要下推的合同
2. 选择要下推的物料明细
3. 填写采购订单信息
4. 确认下推，生成采购订单

### 4.8 打印功能 (60_print)

#### 4.8.1 打印方式
- 通过iframe加载打印页面
- 支持PDF格式预览
- 支持直接打印

#### 4.8.2 打印内容
- 合同基本信息
- 供应商和采购方信息
- 物料明细信息
- 合同条款和条件

## 5. 数据模型设计

### 5.1 主要字段
```javascript
{
  id: "主键ID",
  code: "系统编号",
  contract_code: "合同编号",
  type: "合同类型",
  status: "合同状态",
  supplier_id: "供应商ID",
  supplier_name: "供应商名称",
  purchaser_id: "采购方ID", 
  purchaser_name: "采购方名称",
  contract_date: "合同日期",
  effective_date: "生效日期",
  expiry_date: "失效日期",
  settle_type: "结算方式",
  bill_type: "结算单据类型",
  currency: "币种",
  exchange_rate: "汇率",
  order_amount_total: "合同总金额",
  order_total: "合同总采购数量",
  advance_unpay_total: "预付未付总金额",
  advance_paid_total: "预付已付款总金额",
  remarks: "备注",
  create_time: "创建时间",
  create_user: "创建人",
  update_time: "更新时间",
  update_user: "更新人"
}
```

### 5.2 状态字典
```javascript
DICT_B_PO_CONTRACT_STATUS = {
  "1": "待审批",
  "2": "审批中", 
  "3": "执行中",
  "4": "已完成",
  "5": "驳回",
  "6": "作废审批中",
  "7": "已作废"
}
```

## 6. API接口设计

### 6.1 查询接口
- `POST /api/v1/pocontract/pagelist` - 分页查询合同列表
- `POST /api/v1/pocontract/sum` - 查询合同统计信息
- `POST /api/v1/pocontract/get` - 获取合同详情

### 6.2 操作接口
- `POST /api/v1/pocontract/insert` - 新增合同
- `POST /api/v1/pocontract/save` - 保存/更新合同
- `POST /api/v1/pocontract/delete` - 删除合同
- `POST /api/v1/pocontract/validate` - 验证合同数据

### 6.3 业务流程接口
- `POST /api/v1/pocontract/cancel` - 作废合同
- `POST /api/v1/pocontract/finish` - 完成合同

### 6.4 数据导入导出接口
- `POST /api/v1/pocontract/import` - 导入合同数据
- `POST /api/v1/pocontract/export` - 导出合同数据
- `POST /api/v1/pocontract/export_all` - 导出所有合同数据

### 6.5 报表接口
- `POST /api/v1/pocontract/print` - 打印合同

## 7. 权限控制设计

### 7.1 功能权限
- `P_PO_CONTRACT:ADD` - 新增权限
- `P_PO_CONTRACT:UPDATE` - 修改权限
- `P_PO_CONTRACT:DELETE` - 删除权限
- `P_PO_CONTRACT:CANCEL` - 作废权限
- `P_PO_CONTRACT:AUDIT` - 审批权限
- `P_PO_CONTRACT:PUSH` - 下推权限
- `P_PO_CONTRACT:FINISH` - 完成权限
- `P_PO_CONTRACT:INFO` - 查看权限
- `P_PO_CONTRACT:PRINT` - 打印权限
- `P_PO_CONTRACT:IMPORT` - 导入权限
- `P_PO_CONTRACT:EXPORT` - 导出权限

### 7.2 数据权限
- 基于用户所属组织的数据过滤
- 基于用户角色的数据范围控制
- 支持跨组织的合同管理权限

## 8. 用户界面设计

### 8.1 响应式设计
- 支持不同屏幕尺寸的适配
- 使用Element UI组件库
- 遵循企业级应用的设计规范

### 8.2 交互设计
- 使用标签页切换不同功能页面
- 支持键盘快捷键操作
- 提供友好的错误提示和确认对话框

### 8.3 数据展示
- 列表支持分页、排序、筛选
- 使用图标和颜色区分不同状态
- 提供数据统计和汇总信息

## 9. 技术实现要点

### 9.1 前端技术栈
- **Vue.js 2.x**: 主框架
- **Element UI**: UI组件库
- **Vuex**: 状态管理
- **Vue Router**: 路由管理
- **Axios**: HTTP客户端

### 9.2 关键技术实现
- **标签页管理**: 动态控制标签页的显示/隐藏
- **权限控制**: 基于指令的按钮级权限控制
- **表单验证**: 使用Element UI的表单验证
- **文件上传下载**: 支持Excel格式的导入导出
- **打印功能**: 使用iframe实现PDF预览和打印

### 9.3 代码规范
- 遵循Vue.js官方编码规范
- 使用ESLint进行代码质量检查
- 采用模块化设计，提高代码复用性
- 统一的错误处理和日志记录

## 10. 性能优化

### 10.1 前端优化
- 组件懒加载
- 图片懒加载
- 分页加载大数据集
- 使用虚拟滚动处理大量数据

### 10.2 数据交互优化
- API请求防抖
- 数据缓存策略
- 分页查询优化
- 减少不必要的数据传输

## 11. 测试策略

### 11.1 单元测试
- 组件单元测试
- 工具函数测试
- API接口测试

### 11.2 集成测试
- 页面流程测试
- 数据交互测试
- 权限控制测试

### 11.3 用户验收测试
- 业务流程测试
- 用户体验测试
- 性能压力测试

## 12. 部署和维护

### 12.1 部署要求
- Node.js环境支持
- 现代浏览器兼容性
- 服务器资源配置

### 12.2 维护计划
- 定期代码审查
- 性能监控
- 用户反馈收集
- 功能迭代更新

## 13. 风险控制

### 13.1 技术风险
- 浏览器兼容性问题
- 第三方组件库版本升级风险
- 数据安全和隐私保护

### 13.2 业务风险
- 审批流程变更适应性
- 大数据量处理性能
- 并发操作数据一致性

## 14. 扩展性设计

### 14.1 功能扩展
- 支持自定义字段
- 支持多语言国际化
- 支持移动端适配

### 14.2 集成扩展
- 与其他业务模块的集成
- 第三方系统接口集成
- 工作流引擎集成

---

**文档版本**: 1.0  
**创建日期**: 2025年6月20日  
**更新日期**: 2025年6月20日  
**文档作者**: 系统分析师  
**审核状态**: 待审核
